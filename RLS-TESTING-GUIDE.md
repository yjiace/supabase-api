# RLS策略适配测试指南

## 功能概述

API测试工具现已支持RLS（Row Level Security）策略适配，可以自动检测和处理受RLS保护的接口。

## 主要功能

### 1. 用户认证
- **位置**: 页面右上角"用户登录"按钮
- **功能**: 使用邮箱密码登录获取用户访问令牌
- **状态**: 登录后显示"已登录"状态，可随时登出

### 2. RLS策略检测
- **自动检测**: 系统自动识别受RLS保护的接口
- **标识显示**: 受保护接口会显示"需认证"或"已认证"标识
- **智能提示**: 提供RLS相关的使用说明

### 3. 智能密钥选择
- **用户令牌优先**: 对于受RLS保护的接口，优先使用用户访问令牌
- **服务密钥支持**: 仍支持使用服务密钥绕过RLS策略
- **自动切换**: 根据接口类型和认证状态自动选择合适的密钥

### 4. 错误处理优化
- **403错误分析**: 针对403错误提供详细的解决建议
- **RLS相关提示**: 根据接口特性给出具体的权限配置指导
- **用户友好**: 帮助快速定位和解决权限问题

## 测试步骤

### 步骤1: 配置基础信息
1. 点击"显示配置"
2. 输入Supabase URL和匿名密钥
3. （可选）配置服务端密钥

### 步骤2: 用户认证
1. 点击右上角"用户登录"按钮
2. 输入已注册的邮箱和密码
3. 点击"登录"完成认证

### 步骤3: 测试受保护接口
1. 选择"数据库 (JS SDK)" -> "获取数据"
2. 输入表名（如：users, posts等）
3. 观察接口信息中的RLS保护状态
4. 发送请求测试

### 步骤4: 对比测试
1. **已认证状态**: 使用用户令牌，遵循RLS策略
2. **未认证状态**: 使用匿名密钥，可能返回403错误
3. **服务密钥**: 绕过RLS策略，获得完全访问权限

## 常见场景

### 场景1: 用户数据访问
- **接口**: GET /rest/v1/users
- **RLS策略**: 用户只能查看自己的数据
- **测试**: 登录后查询，应只返回当前用户数据

### 场景2: 公共数据访问
- **接口**: GET /rest/v1/posts
- **RLS策略**: 所有用户可查看公开文章
- **测试**: 无需登录即可查询公开数据

### 场景3: 管理员操作
- **接口**: DELETE /rest/v1/users
- **RLS策略**: 需要管理员权限
- **测试**: 使用服务密钥或管理员账户

## 错误处理示例

### 403 Forbidden错误
系统会自动分析403错误并提供解决建议：

```
403 Forbidden - 可能的解决方案:
• 此接口受RLS策略保护，需要用户登录认证
• 请点击"用户登录"按钮进行认证
```

或

```
403 Forbidden - 可能的解决方案:
• 用户已认证但仍被拒绝，可能原因:
  - RLS策略不允许当前用户访问此资源
  - 访问令牌已过期，请重新登录
  - 数据库表未启用RLS或策略配置错误
```

## 注意事项

1. **用户注册**: 确保测试用户已在Supabase项目中注册
2. **RLS策略**: 确保数据库表已启用RLS并配置了相应策略
3. **权限设置**: 验证用户角色和权限配置是否正确
4. **令牌有效期**: 用户访问令牌有时效性，过期后需重新登录

## 技术实现

- **认证状态管理**: 使用localStorage持久化认证信息
- **智能密钥选择**: 根据接口类型自动选择认证方式
- **错误分析**: 基于HTTP状态码和接口特性提供解决建议
- **用户体验**: 提供直观的状态指示和操作引导